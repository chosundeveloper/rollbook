name: Deploy to Server

on:
  push:
    branches:
      - main  # main ë¸Œëœì¹˜ì— í‘¸ì‹œí•˜ë©´ ìë™ ë°°í¬
  workflow_dispatch:  # ìˆ˜ë™ ë°°í¬ë„ ê°€ëŠ¥

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Add server to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to server
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
          ROLLBOOK_SESSION_SECRET: ${{ secrets.ROLLBOOK_SESSION_SECRET }}
        run: |
          echo "ğŸš€ Deploying to ${SERVER_HOST}..."

          # ì„œë²„ì— ë””ë ‰í† ë¦¬ ìƒì„±
          ssh ${SERVER_USER}@${SERVER_HOST} "mkdir -p ${SERVER_PATH}"

          # íŒŒì¼ ì „ì†¡ (rsync)
          rsync -avz --delete \
            --exclude 'node_modules' \
            --exclude '.next' \
            --exclude '.git' \
            --exclude 'data' \
            --exclude 'deployment/traefik-data/acme.json' \
            --exclude '.github' \
            ./ ${SERVER_USER}@${SERVER_HOST}:${SERVER_PATH}/

          # .env íŒŒì¼ ìƒì„±
          ssh ${SERVER_USER}@${SERVER_HOST} << EOF
            cd ${SERVER_PATH}
            echo "ROLLBOOK_SESSION_SECRET=${ROLLBOOK_SESSION_SECRET}" > .env
            echo "NEXT_PUBLIC_AUTH_DISABLED=false" >> .env
          EOF

          # Docker ë¹Œë“œ ë° ë°°í¬
          ssh ${SERVER_USER}@${SERVER_HOST} << 'EOF'
            cd ${SERVER_PATH}

            # data ë””ë ‰í† ë¦¬ ì´ˆê¸°í™” (ì´ˆê¸° ë°°í¬ì‹œë§Œ)
            if [ ! -d "data" ]; then
              echo "ğŸ“‹ Initializing data directory..."
              mkdir -p data
            fi

            # Docker ì»¨í…Œì´ë„ˆ ì¬ë°°í¬
            docker-compose down
            docker-compose up -d --build

            echo "âœ… Deployment complete!"
            docker-compose ps
          EOF

      - name: Check deployment status
        env:
          SERVER_USER: ${{ secrets.SERVER_USER }}
          SERVER_HOST: ${{ secrets.SERVER_HOST }}
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          echo "ğŸ“‹ Checking deployment status..."
          ssh ${SERVER_USER}@${SERVER_HOST} "cd ${SERVER_PATH} && docker-compose logs --tail=50"
